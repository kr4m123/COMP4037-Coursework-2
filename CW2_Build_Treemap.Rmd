---
title: "CW2"
author: "Mark Freeth"
date: "2025-03-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

```{r packages, errors=FALSE}
# required packages (uncomment if they are needed to be installed):
# install.packages(c("dplyr", "tidyr", "ggplot2", "treemapify", "readr"))

# load required libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(treemapify)
library(readr)
```

```{r load_data}
# load data file, change categorical columns to factors
data <- read_csv("Results_21Mar2022.csv", 
  col_types = cols(sex = col_factor(levels = c("female", "male")), 
                  diet_group = col_factor(levels = c("meat100", "meat50", "meat", "vegan", "veggie", "fish")), 
                  age_group = col_factor(levels = c("20-29", "30-39", "40-49", "50-59", "60-69", "70-79"))))
```

```{r aggreg_data}
# aggregate the measures in each monte carlo run by taking the mean
# means are taken first before standardising, want to take average of all monte carlo runs, don't care about variability between monte carlo runs
aggregated_data <- data %>%
  group_by(diet_group, age_group, sex) %>%
  summarise(
    across(c(mean_ghgs, mean_land, mean_watscar, mean_eut, mean_ghgs_ch4, 
             mean_ghgs_n2o, mean_bio, mean_watuse, mean_acid), 
           mean, na.rm = TRUE),
    n_participants = first(n_participants)
  ) %>%
  ungroup()
```

```{r standardising}
# calculate Z scores for each measure
standardised_data <- aggregated_data %>%
  mutate(across(
    starts_with("mean_"), 
    ~ (.-mean(.)) / sd(.), 
    .names = "z_{.col}"
  ))
```


```{r total_impact}
# calculate total impact score
total_impact <- standardised_data %>%
  rowwise() %>%
  mutate(total_impact = sum(c_across(starts_with("z_")), na.rm = TRUE)) %>%
  ungroup()
```

```{r treemap_data}
# select columns used for the treemap
treemap_data <- total_impact %>%
  select(diet_group, age_group, sex, total_impact) %>%
  mutate(total_impact = total_impact)
```

```{r rename_vals}
# rename the diet groups
treemap_data <- treemap_data %>%
  mutate(diet_group = case_when(
    diet_group == "meat100" ~ "High Meat",
    diet_group == "meat" ~ "Medium Meat",
    diet_group == "meat50" ~ "Low Meat",
    diet_group == "vegan" ~ "Vegan",
    diet_group == "veggie" ~ "Vegetarian",
    diet_group == "fish" ~ "Fish",
    TRUE ~ diet_group
  ))

# rename the sexes (makes plot look less cluttered)
treemap_data <- treemap_data %>%
  mutate(sex = case_when(
    sex == "female" ~ "Female",
    sex == "male" ~ "Male"
  ))
```


```{r treemap, fig.width=12, fig.height=8, dpi=300}
# constructing the treemap
ggplot(treemap_data,
       aes(area = abs(total_impact),  
           fill = total_impact,  
           label = paste0(sex, "\n(", age_group, ")\n", round(total_impact, 2)),  # the actual label displayed on each rectangle
           subgroup = diet_group,
           subgroup2 = age_group)) +
  geom_treemap() +
  
  # # borders around each sex group
  # geom_treemap_subgroup3_border(size = 1, colour = "black") +
  
  # borders around each diet group
  geom_treemap_subgroup2_border(size = 3, colour = "black") +
  
  # borders around each age group
  geom_treemap_subgroup_border(size = 9, colour = "black") +
  
  # text styling for individual rectangle/cell
  geom_treemap_text(
    colour = "black",
    min.size = 0.5,
    place = "center",
    grow = FALSE,
    reflow = TRUE
  ) +
  
  # text styling for each diet group
  geom_treemap_subgroup_text(
    place = "center", 
    grow = FALSE, 
    alpha = 0.9, 
    colour = "#0096FF", 
    fontface = "bold.italic", 
    size = 20
  ) +
  
  # color scale, green is lowest impact, red is highest impact, intermediate values are a gradient
  scale_fill_gradient2(
    low = "darkgreen",
    mid = "white",
    high = "#bb0000",
    name = "Difference From Mean Environmental Impact",
    guide = guide_colorbar(
      barwidth = 20,
      barheight = 0.8
    ),
    breaks = c(-15, -12, -9, -6, -3, 0, 3, 6, 9, 12, 15, 18),  
    labels = c("-15", "-12", "-9", "-6", "-3", "0", "3", "6", "9", "12", "15", "18")
  ) +
  
  ggtitle("Environmental Impact by Diet Group") +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.title = element_text(margin = margin(r = 10)))

ggsave("treemap.png", width = 11, height = 6, dpi = 300)

```